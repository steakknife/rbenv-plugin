#!/bin/sh -ex

list() {
  echo "rbenv plugins:"
  ls -1 "$RBENV_PLUGINS_ROOT" | tr '\n' '\0' | xargs -0 -n 1 basename | sed -e 's/^rbenv-//g;/^plugin$/d'
}

add() {
  URL="$1"
  echo "$URL" | egrep -qs '^(git|http)' || URL="https://github.com/$URL"
  PLUGIN_NAME="$(echo $URL | sed 's/.*\(rbenv-[^\.]*\).*/\1/;s/.*\(ruby-build\).*/ruby-build/')"
  if [ "$PLUGIN_NAME" = "update" ]; then
    echo "Cannot overwrite update plugin" >&2
    exit 1
  fi
  if [ "$PLUGIN_NAME" = "$URL" ]; then
    echo "Cannot detect plugin name" >&2
    exit 1
  fi
  git clone "$URL" "$RBENV_PLUGINS_ROOT/$PLUGIN_NAME"
}

rm() {
  PLUGIN_NAME="$1"
  if [ "$NAME" != 'ruby-build' ]; then
    PLUGIN_NAME="rbenv-$NAME"
  fi
  if [ "$PLUGIN_NAME" = "plugin" ]; then
    echo "Cannot delete rbenv-plugin" >&2
    exit 1
  fi
  if [ ! -d "$RBENV_PLUGINS_ROOT/$PLUGIN_NAME" ]; then
    echo "PLUGIN_NAME=$PLUGIN_NAME"
    echo "rbenv plugin $PLUGIN_NAME not found" >&2
    exit 1
  fi
  \rm -rf "$RBENV_PLUGINS_ROOT/$PLUGIN_NAME"
  if ! $?; then
    echo "Cannot delete rbenv plugin $1" >&2
    exit 1
  fi
  echo "Deleted rbenv plugin $1"
}

help() {
  cat << EOF
rbenv plugin list        list plugins
rbenv plugin add   url   add plugin  
rbenv plugin rm  plugin  remove plugin  
EOF
}

COMMAND="$1" ; shift
[ -z "$RBENV_ROOT" ] && RBENV_ROOT="$(cd ~/.rbenv/plugins ; pwd)"
RBENV_PLUGINS_ROOT="$RBENV_ROOT/plugins"
$COMMAND "$@"
